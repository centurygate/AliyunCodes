var g_chartid = 1;

$(document).ready(function(){
    $("body").css("min-height",$(window).height()-90);
    $(".demo").css("min-height",$(window).height()-130);

    $(".demo").sortable({
        handle:".drag"
    });

    $(".sidebar-nav .lyrow").draggable({
        connectToSortable:".demo",
        helper:"clone",
        handle:".drag",
        drag: function(e,t){
            t.helper.width(400)
        },
        stop: function(e,t) {
            var chart1 = "<div id='" + g_chartid + "' style='width: 100%;height:100%;'></div>"
            var currentColumn = $(".demo .column:not(.added)");
            currentColumn.append(chart1);
            var rslut = startechart(g_chartid);
            if(rslut == null)
            {
                //bug,删除新添加的<div>标签
                currentColumn.remove("#g_chartid");
                g_chartid++;
                return;
            }
            g_chartid++;

            //新加入的column添加class：“added”
            currentColumn.addClass("added");
        }
    });


    $(".demo").delegate(".remove","click",function(e){
            e.preventDefault();
            $(this).parent().remove();
            if(!$(".demo .lyrow").length>0){
                clearDemo();
            }
        }
    )


    function clearDemo(){
        $(".demo").empty();
    }
})


//启动echart的动态图表功能
function startechart(id){

    var myChart;
    //初始化图表控件
    var findid = document.getElementById(id);
    if(findid == null)
    {
        return null;
    }
    else{
        myChart = echarts.init(findid);
    }

    //初始空白没有数据的option
    var option = {
        title: {
            text: '动态数据'
        },
        tooltip: {
            trigger: 'axis'
        },
        legend: {
            data:['最新成交价']
        },
/*        toolbox: {
            show: true,
            feature: {
                dataView: {readOnly: false},
                restore: {},
                saveAsImage: {}
            }
        },*/
        dataZoom: {
            show: false,
            start: 0,
            end: 100
        },
        xAxis: {
            type: 'category',
            boundaryGap: false,
            data: (function (){
                var now = new Date();
                var res = [];
                var len = 20;
                while (len--) {
                    res.unshift(now.toLocaleTimeString().replace(/^\D*/,''));
                    now = new Date(now - 2000);
                }
                return res;
            })()
        },
        yAxis: {
            type: 'value',
            scale: true,
            name: '价格',
            max: 30,
            min: 0,
            boundaryGap: [0.2, 0.2]
        },
        series: [
            {
                name:'最新成交价',
                type:'line',
                data:(function (){
                    var res = [];
                    var len = 0;
                    while (len < 20) {
                        res.push((Math.random()*10 + 5).toFixed(1) - 0);
                        len++;
                    }
                    return res;
                })()
            }
        ]
    };


    window.setInterval(function (){

        option.series[0].data.shift();
        option.series[0].data.push((Math.random() * 10 + 5).toFixed(1) - 0);

        var axisData = (new Date()).toLocaleTimeString().replace(/^\D*/,'');
        option.xAxis.data.shift();
        option.xAxis.data.push(axisData);

        myChart.setOption(option);
    }, 2000);

    return 1;
}

